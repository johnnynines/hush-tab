# Copilot Instructions - Browser Extension Development

## Project Context
This is a browser extension project targeting both Mozilla Firefox and Google Chrome. The extension is designed to mute ads.

## Browser Extension Fundamentals

### Manifest File
- **Chrome (Manifest V3)**: Use `manifest.json` with `"manifest_version": 3`
- **Firefox**: Supports both Manifest V2 and V3, but V3 is recommended for cross-browser compatibility
- Key fields: `name`, `version`, `description`, `permissions`, `background`, `content_scripts`, `action`

### Cross-Browser Compatibility
- Use the WebExtensions API which is supported by both browsers
- Chrome uses `chrome.*` namespace, Firefox uses `browser.*` (with Promise-based APIs)
- Use a polyfill like `webextension-polyfill` for consistent API across browsers
- Test on both browsers as behavior can differ

### File Structure
```
project/
├── manifest.json          # Extension configuration
├── background/           # Background scripts (service workers in MV3)
├── content/             # Content scripts (run on web pages)
├── popup/               # Browser action popup UI
├── options/             # Options/settings page
├── icons/               # Extension icons (16x16, 48x48, 128x128)
└── lib/                 # Shared libraries and utilities
```

## Key Development Concepts

### Content Scripts
- Run in the context of web pages
- Have access to the DOM but isolated JavaScript environment
- Cannot directly access most WebExtension APIs
- Communicate with background scripts via `chrome.runtime.sendMessage` / `browser.runtime.sendMessage`
- Define in manifest under `content_scripts` with `matches` patterns

### Background Scripts / Service Workers
- **Manifest V2**: Persistent background pages
- **Manifest V3**: Service workers (event-driven, non-persistent)
- Handle events, maintain state, perform cross-origin requests
- Have full access to WebExtension APIs
- Define in manifest under `background` with `service_worker` (MV3) or `scripts` (MV2)

### Permissions
- Request minimal necessary permissions in manifest
- Common permissions: `activeTab`, `storage`, `tabs`, `webRequest`, `webNavigation`
- Host permissions for accessing specific websites: `"host_permissions": ["*://*.example.com/*"]`
- Chrome Web Store may reject extensions with excessive permissions

### Storage
- Use `chrome.storage.local` / `browser.storage.local` for local storage
- Use `chrome.storage.sync` / `browser.storage.sync` for synced storage across devices
- Prefer storage API over localStorage (works in all contexts)

### Messaging
- **One-time messages**: `runtime.sendMessage()` and `runtime.onMessage`
- **Long-lived connections**: `runtime.connect()` and `runtime.onConnect`
- Content script to background: `chrome.runtime.sendMessage()`
- Background to content script: `chrome.tabs.sendMessage(tabId, message)`

## Audio/Video Muting Specific

### Muting Media Elements
```javascript
// In content script
document.querySelectorAll('video, audio').forEach(element => {
  element.muted = true;
  element.volume = 0;
});

// Watch for dynamically added media
const observer = new MutationObserver(mutations => {
  document.querySelectorAll('video, audio').forEach(element => {
    element.muted = true;
  });
});
```

### Tab Muting API
```javascript
// In background script
chrome.tabs.update(tabId, { muted: true });

// Listen for tab updates
chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
  if (changeInfo.audible) {
    // Tab started playing audio
  }
});
```

## Development Workflow

### Testing
- **Chrome**: Navigate to `chrome://extensions/`, enable Developer mode, click "Load unpacked"
- **Firefox**: Navigate to `about:debugging#/runtime/this-firefox`, click "Load Temporary Add-on"
- Use `console.log()` in content scripts (appears in page console)
- Use `console.log()` in background (appears in extension console/service worker inspector)

### Debugging
- **Chrome**: Right-click extension icon → "Inspect popup" or go to `chrome://extensions/` and click "Inspect views: background page"
- **Firefox**: `about:debugging` → Inspect for your extension
- Use `debugger;` statements for breakpoints

### Hot Reloading
- Changes to content scripts require page reload
- Changes to background scripts require extension reload
- Changes to manifest require extension reload
- Consider using tools like `web-ext` (Firefox) for auto-reload

## Building and Packaging

### Firefox
- Use `web-ext build` command
- Creates a `.zip` file for submission
- Requires signing for distribution (unless developer edition)
- Submit to addons.mozilla.org (AMO)

### Chrome
- Create a ZIP of the extension directory
- Upload to Chrome Web Store Developer Dashboard
- Must have icons in required sizes (16, 48, 128)
- Pay one-time developer registration fee

## Best Practices

1. **Performance**: Keep background scripts lightweight, use event pages/service workers
2. **Security**: Validate all inputs, use Content Security Policy, avoid `eval()`
3. **Privacy**: Minimize data collection, be transparent about permissions
4. **Updates**: Use semantic versioning, test thoroughly before publishing
5. **Error Handling**: Wrap API calls in try-catch, handle permission errors gracefully
6. **Accessibility**: Ensure popup and options pages are keyboard navigable
7. **Localization**: Use `chrome.i18n` API for multi-language support

## Common Pitfalls

- Forgetting to reload extension after code changes
- Not handling async operations properly (Promises in Firefox, callbacks in Chrome)
- CSP violations when using inline scripts
- Service worker lifecycle issues in Manifest V3
- Cross-origin issues without proper permissions
- Not testing on both browsers

## Useful Resources

- [Chrome Extensions Documentation](https://developer.chrome.com/docs/extensions/)
- [Firefox Extension Workshop](https://extensionworkshop.com/)
- [MDN WebExtensions API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions)
- [webextension-polyfill](https://github.com/mozilla/webextension-polyfill)
- [web-ext CLI tool](https://extensionworkshop.com/documentation/develop/getting-started-with-web-ext/)

## Development Commands

```bash
# Install web-ext for Firefox development
npm install --global web-ext

# Run extension in Firefox with auto-reload
web-ext run

# Build extension for distribution
web-ext build

# Lint extension
web-ext lint
```
